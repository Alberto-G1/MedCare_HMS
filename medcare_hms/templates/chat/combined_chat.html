{% extends 'base_shared.html' %}
{% load static %}
{% load profile_tags %}

{% block title %}Messages - MedCare HMS{% endblock %}

{% block extra_head %}
<style>
    /* Override base padding to allow full width */
    .content-adaptive {
        padding: 0 !important;
        min-height: calc(100vh - 76px) !important;
    }

    /* ============================================
       CHAT CONTAINER - Full Width Split View
       ============================================ */
    .chat-app-container {
        height: calc(100vh - 76px);
        display: flex;
        background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
        overflow: hidden;
        margin: 0 !important;
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw !important;
        margin-right: -50vw !important;
    }

    /* ============================================
       SIDEBAR - Thread List
       ============================================ */
    .chat-sidebar {
        width: 380px;
        background: white;
        border-right: 1px solid #E2E8F0;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 20px rgba(0, 0, 0, 0.05);
    }

    .chat-sidebar-header {
        padding: 1.5rem;
        background: linear-gradient(135deg, #0E7490 0%, #0C4A6E 100%);
        color: white;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .sidebar-header-title h4 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .total-unread-badge {
        background: linear-gradient(135deg, #F97316, #EA580C);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .sidebar-search {
        position: relative;
        margin-top: 0.75rem;
    }

    .sidebar-search input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .sidebar-search input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    .sidebar-search input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .sidebar-search i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255, 255, 255, 0.8);
        font-size: 1rem;
    }

    .chat-threads-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .thread-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        background: white;
        text-decoration: none;
        color: inherit;
    }

    .thread-item:hover {
        background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
        transform: translateX(5px);
        border-color: rgba(14, 116, 144, 0.2);
        text-decoration: none;
    }

    .thread-item.active {
        background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
        border-color: #0E7490;
        box-shadow: 0 4px 12px rgba(14, 116, 144, 0.2);
    }

    .thread-avatar {
        position: relative;
        margin-right: 1rem;
    }

    .thread-avatar img {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .thread-avatar .online-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .thread-avatar .online-indicator.online {
        background: linear-gradient(135deg, #22C55E, #16A34A);
        animation: pulse-online 2s infinite;
    }

    .thread-avatar .online-indicator.offline {
        background: #94A3B8;
    }

    @keyframes pulse-online {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
        }
    }

    .thread-content {
        flex: 1;
        min-width: 0;
    }

    .thread-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
    }

    .thread-name {
        font-weight: 600;
        font-size: 1rem;
        color: #1E293B;
        margin: 0;
    }

    .thread-time {
        font-size: 0.75rem;
        color: #94A3B8;
        white-space: nowrap;
    }

    .thread-preview {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .thread-preview-text {
        font-size: 0.875rem;
        color: #64748B;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }

    .thread-preview-text.unread {
        color: #1E293B;
        font-weight: 600;
    }

    .thread-unread-badge {
        background: linear-gradient(135deg, #0E7490, #0C4A6E);
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
        min-width: 22px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(14, 116, 144, 0.3);
        animation: bounce-in 0.5s;
    }

    @keyframes bounce-in {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .empty-thread-list {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #94A3B8;
    }

    .empty-thread-list i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* ============================================
       MAIN CHAT AREA
       ============================================ */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #F8FAFC;
        position: relative;
    }

    .chat-main-header {
        padding: 1.25rem 1.5rem;
        background: white;
        border-bottom: 1px solid #E2E8F0;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
        z-index: 10;
    }

    .chat-header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-header-user {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chat-header-avatar {
        position: relative;
    }

    .chat-header-avatar img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .chat-header-avatar .online-indicator {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid white;
    }

    .chat-header-avatar .online-indicator.online {
        background: linear-gradient(135deg, #22C55E, #16A34A);
        animation: pulse-online 2s infinite;
    }

    .chat-header-avatar .online-indicator.offline {
        background: #94A3B8;
    }

    .chat-header-info h5 {
        margin: 0;
        font-weight: 700;
        color: #1E293B;
        font-size: 1.125rem;
    }

    .chat-header-status {
        font-size: 0.875rem;
        color: #22C55E;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .chat-header-status.offline {
        color: #94A3B8;
    }

    .chat-header-status .typing-dots {
        display: inline-flex;
        gap: 3px;
        margin-left: 0.25rem;
    }

    .typing-dot {
        width: 4px;
        height: 4px;
        background: #22C55E;
        border-radius: 50%;
        animation: typing-dot 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing-dot {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
    }

    .chat-header-actions {
        display: flex;
        gap: 0.75rem;
    }

    .chat-header-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #E2E8F0;
        background: white;
        color: #64748B;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chat-header-btn:hover {
        background: linear-gradient(135deg, #0E7490, #0C4A6E);
        color: white;
        border-color: #0E7490;
        transform: scale(1.05);
    }

    /* Patient Context Panel */
    .patient-context-panel {
        margin-top: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        border-radius: 12px;
        border: 2px solid #FCD34D;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }

    .context-item {
        text-align: center;
    }

    .context-label {
        font-size: 0.75rem;
        color: #92400E;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .context-value {
        font-size: 1rem;
        color: #78350F;
        font-weight: 700;
    }

    /* Messages Area */
    .chat-messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
    }

    .message-date-divider {
        text-align: center;
        margin: 1.5rem 0;
        position: relative;
    }

    .message-date-divider::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 1px;
        background: linear-gradient(90deg, transparent, #CBD5E1, transparent);
    }

    .message-date-divider span {
        background: white;
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        font-size: 0.75rem;
        color: #64748B;
        font-weight: 600;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .message-wrapper {
        display: flex;
        margin-bottom: 1rem;
        animation: message-slide-in 0.3s ease;
    }

    @keyframes message-slide-in {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-wrapper.sent {
        justify-content: flex-end;
    }

    .message-wrapper.received {
        justify-content: flex-start;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 0.75rem;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message-bubble {
        max-width: 65%;
        padding: 0.875rem 1.125rem;
        border-radius: 16px;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .message-wrapper.sent .message-bubble {
        background: linear-gradient(135deg, #0E7490 0%, #0C4A6E 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-wrapper.received .message-bubble {
        background: white;
        color: #1E293B;
        border-bottom-left-radius: 4px;
        border: 1px solid #E2E8F0;
    }

    .message-content {
        word-wrap: break-word;
        line-height: 1.5;
        font-size: 0.95rem;
    }

    /* File Attachments in Messages */
    .message-attachment {
        margin-top: 0.5rem;
    }

    .message-attachment img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .message-attachment img:hover {
        transform: scale(1.02);
    }

    .file-attachment {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        margin-top: 0.5rem;
        transition: all 0.3s ease;
    }

    .message-wrapper.received .file-attachment {
        background: #F1F5F9;
    }

    .file-attachment:hover {
        transform: translateX(3px);
    }

    .file-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
        background: linear-gradient(135deg, #0E7490, #0C4A6E);
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: inherit;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-size {
        font-size: 0.75rem;
        opacity: 0.7;
    }

    .file-download {
        color: inherit;
        text-decoration: none;
        font-size: 1.125rem;
        transition: transform 0.3s ease;
    }

    .file-download:hover {
        transform: scale(1.2);
    }

    .message-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        opacity: 0.7;
    }

    .message-time {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .read-receipt {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.875rem;
    }

    .read-receipt.read {
        color: #22C55E;
    }

    /* Input Area */
    .chat-input-container {
        padding: 1.25rem 1.5rem;
        background: white;
        border-top: 1px solid #E2E8F0;
        box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.05);
    }

    .canned-responses-row {
        margin-bottom: 0.75rem;
    }

    .canned-responses-dropdown {
        width: 100%;
        padding: 0.625rem 1rem;
        border: 2px solid #E2E8F0;
        border-radius: 10px;
        font-size: 0.875rem;
        color: #64748B;
        background: #F8FAFC;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .canned-responses-dropdown:focus {
        outline: none;
        border-color: #0E7490;
        background: white;
    }

    .file-preview-area {
        background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
        border: 2px dashed #0E7490;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: none;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .file-preview-area.show {
        display: block;
    }

    .file-preview-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .file-preview-icon {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        background: linear-gradient(135deg, #0E7490, #0C4A6E);
    }

    .file-preview-info {
        flex: 1;
        min-width: 0;
    }

    .file-preview-name {
        font-weight: 600;
        color: #1E293B;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.9rem;
    }

    .file-preview-size {
        font-size: 0.8rem;
        color: #64748B;
    }

    .file-preview-remove {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #F97316, #EA580C);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .file-preview-remove:hover {
        transform: rotate(90deg) scale(1.1);
    }

    .chat-input-form {
        display: flex;
        align-items: flex-end;
        gap: 0.75rem;
    }

    .input-actions {
        display: flex;
        gap: 0.5rem;
    }

    .input-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: 2px solid #E2E8F0;
        background: white;
        color: #64748B;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.125rem;
    }

    .input-btn:hover {
        background: linear-gradient(135deg, #0E7490, #0C4A6E);
        color: white;
        border-color: #0E7490;
        transform: scale(1.05);
    }

    .message-input {
        flex: 1;
        padding: 0.875rem 1.25rem;
        border: 2px solid #E2E8F0;
        border-radius: 12px;
        font-size: 0.95rem;
        resize: none;
        max-height: 120px;
        min-height: 44px;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }

    .message-input:focus {
        outline: none;
        border-color: #0E7490;
        box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.1);
    }

    .send-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #0E7490, #0C4A6E);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.25rem;
        box-shadow: 0 4px 12px rgba(14, 116, 144, 0.3);
    }

    .send-btn:hover:not(:disabled) {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 6px 20px rgba(14, 116, 144, 0.4);
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Empty State */
    .chat-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #94A3B8;
        text-align: center;
        padding: 2rem;
    }

    .chat-empty-state i {
        font-size: 6rem;
        margin-bottom: 1.5rem;
        opacity: 0.3;
        background: linear-gradient(135deg, #0E7490, #0C4A6E);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .chat-empty-state h3 {
        color: #64748B;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .chat-empty-state p {
        color: #94A3B8;
    }

    /* Image Lightbox */
    .image-lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .image-lightbox.show {
        display: flex;
    }

    .lightbox-close {
        position: absolute;
        top: 2rem;
        right: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: white;
        color: #1E293B;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .lightbox-close:hover {
        transform: rotate(90deg) scale(1.1);
        background: #F97316;
        color: white;
    }

    .lightbox-image {
        max-width: 90%;
        max-height: 90%;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    /* Scrollbar Styling */
    .chat-threads-list::-webkit-scrollbar,
    .chat-messages-container::-webkit-scrollbar {
        width: 8px;
    }

    .chat-threads-list::-webkit-scrollbar-track,
    .chat-messages-container::-webkit-scrollbar-track {
        background: #F1F5F9;
    }

    .chat-threads-list::-webkit-scrollbar-thumb,
    .chat-messages-container::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #0E7490, #0C4A6E);
        border-radius: 10px;
    }

    .chat-threads-list::-webkit-scrollbar-thumb:hover,
    .chat-messages-container::-webkit-scrollbar-thumb:hover {
        background: #0C4A6E;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .chat-app-container {
            position: relative;
        }

        .chat-sidebar {
            width: 100%;
            position: absolute;
            z-index: 100;
            height: 100%;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .chat-sidebar.show-mobile {
            transform: translateX(0);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
        }

        .chat-main {
            width: 100%;
        }

        /* Mobile back button */
        .mobile-back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid #E2E8F0;
            color: #0E7490;
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.3s ease;
        }

        .mobile-back-btn:hover {
            background: #0E7490;
            color: white;
        }

        .message-bubble {
            max-width: 85%;
        }

        .patient-context-panel {
            grid-template-columns: repeat(2, 1fr);
        }

        .file-preview-area {
            padding: 0.75rem;
        }

        .file-preview-icon {
            width: 40px;
            height: 40px;
            font-size: 1.25rem;
        }

        .message-attachment img {
            max-height: 200px;
        }

        .chat-header-actions {
            display: none;
        }

        .thread-item {
            padding: 0.875rem;
        }

        .thread-avatar img {
            width: 48px;
            height: 48px;
        }

        .sidebar-search input {
            font-size: 0.9rem;
        }
    }

    /* Hide mobile back button on desktop */
    @media (min-width: 769px) {
        .mobile-back-btn {
            display: none !important;
        }
    }
        

        .patient-context-panel {
            grid-template-columns: repeat(2, 1fr);
        }

        .file-preview-area {
            padding: 0.75rem;
        }

        .file-preview-icon {
            width: 40px;
            height: 40px;
            font-size: 1.25rem;
        }

        .message-attachment img {
            max-height: 200px;
        }
    
</style>
{% endblock %}

{% block content %}
<div class="chat-app-container">
    <!-- SIDEBAR - Thread List -->
    <div class="chat-sidebar">
        <div class="chat-sidebar-header">
            <div class="sidebar-header-title">
                <h4>
                    <i class="fas fa-comments"></i>
                    Messages
                </h4>
                {% if total_unread > 0 %}
                <span class="total-unread-badge">{{ total_unread }}</span>
                {% endif %}
            </div>
            <div class="sidebar-search">
                <i class="fas fa-search"></i>
                <input type="text" id="search-threads" placeholder="Search conversations...">
            </div>
        </div>

        <div class="chat-threads-list">
            {% if threads %}
                {% for thread_data in threads %}
                <a href="{% url 'chat:thread_detail' thread_data.thread_object.id %}" 
                   class="thread-item {% if active_thread and active_thread.id == thread_data.thread_object.id %}active{% endif %}"
                   data-thread-id="{{ thread_data.thread_object.id }}">
                    <!-- Avatar with Online Status -->
                    <div class="thread-avatar">
                        {% profile_image thread_data.other_user size="56" css_class="thread-avatar-img" %}
                        <span class="online-indicator {% if thread_data.is_online %}online{% else %}offline{% endif %}"></span>
                    </div>

                    <!-- Thread Content -->
                    <div class="thread-content">
                        <div class="thread-header">
                            <h6 class="thread-name">
                                {{ thread_data.other_user.get_full_name|default:thread_data.other_user.username }}
                            </h6>
                            {% if thread_data.last_message %}
                            <span class="thread-time">{{ thread_data.last_message.timestamp|timesince }} ago</span>
                            {% endif %}
                        </div>
                        <div class="thread-preview">
                            {% if thread_data.last_message %}
                            <span class="thread-preview-text {% if thread_data.unread_count > 0 %}unread{% endif %}">
                                {% if thread_data.last_message.sender == request.user %}
                                    <strong>You:</strong> 
                                {% endif %}
                                {% if thread_data.last_message.attachment %}
                                    <i class="fas fa-paperclip"></i> Attachment
                                {% else %}
                                    {{ thread_data.last_message.message|truncatewords:6 }}
                                {% endif %}
                            </span>
                            {% endif %}
                            {% if thread_data.unread_count > 0 %}
                            <span class="thread-unread-badge">{{ thread_data.unread_count }}</span>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-thread-list">
                    <i class="fas fa-inbox"></i>
                    <h5>No conversations yet</h5>
                    <p>Start a new chat to see it here</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- MAIN CHAT AREA -->
    <div class="chat-main">
        {% if active_thread %}
            <!-- Hidden current-user avatar probe to safely capture avatar URL in JS without injecting HTML into strings -->
            <div id="current-user-avatar-probe" style="display:none;">
                {% profile_image request.user size="36" css_class="current-user-avatar-probe" %}
            </div>
            <!-- Chat Header -->
            <div class="chat-main-header">
                <div class="chat-header-top">
                    <div class="chat-header-user">
                        <!-- Mobile Back Button -->
                        <button class="mobile-back-btn" id="mobile-back-btn" title="Back to conversations">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        
                        <div class="chat-header-avatar">
                            {% profile_image other_user size="50" css_class="chat-header-avatar-img" %}
                            <span class="online-indicator {% if is_online %}online{% else %}offline{% endif %}"></span>
                        </div>
                        <div class="chat-header-info">
                            <h5>{{ other_user.get_full_name|default:other_user.username }}</h5>
                            <div class="chat-header-status {% if not is_online %}offline{% endif %}" id="user-status">
                                {% if is_online %}
                                    <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                                    <span id="status-text">Online</span>
                                    <span class="typing-indicator" style="display: none;">
                                        <span class="typing-dots">
                                            <span class="typing-dot"></span>
                                            <span class="typing-dot"></span>
                                            <span class="typing-dot"></span>
                                        </span>
                                    </span>
                                {% else %}
                                    <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                                    Last seen {{ last_seen|timesince }} ago
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-header-btn" title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="chat-header-btn" title="More options">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>

                <!-- Patient Context Panel -->
                {% if patient_context %}
                <div class="patient-context-panel">
                    <div class="context-item">
                        <div class="context-label">
                            <i class="fas fa-calendar-alt"></i> Age
                        </div>
                        <div class="context-value">{{ patient_context.age }}</div>
                    </div>
                    <div class="context-item">
                        <div class="context-label">
                            <i class="fas fa-venus-mars"></i> Gender
                        </div>
                        <div class="context-value">{{ patient_context.gender }}</div>
                    </div>
                    <div class="context-item">
                        <div class="context-label">
                            <i class="fas fa-tint"></i> Blood
                        </div>
                        <div class="context-value">{{ patient_context.blood_group }}</div>
                    </div>
                    <div class="context-item">
                        <div class="context-label">
                            <i class="fas fa-phone"></i> Contact
                        </div>
                        <div class="context-value">{{ patient_context.contact }}</div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Messages Container -->
            <div class="chat-messages-container" id="messages-container">
                {% for message in messages %}
                    {% ifchanged message.timestamp.date %}
                    <div class="message-date-divider">
                        <span>{{ message.timestamp|date:"F j, Y" }}</span>
                    </div>
                    {% endifchanged %}

                    <div class="message-wrapper {% if message.sender == request.user %}sent{% else %}received{% endif %}" data-message-id="{{ message.id }}">
                        {% if message.sender != request.user %}
                        {% profile_image message.sender size="36" css_class="message-avatar" %}
                        {% endif %}

                        <div class="message-bubble">
                            <div class="message-content">
                                {{ message.message }}
                            </div>

                            <!-- File Attachment -->
                            {% if message.attachment %}
                            <div class="message-attachment">
                                {% if message.attachment_type == 'image' %}
                                    <img src="{{ message.attachment.url }}" 
                                         alt="Attachment" 
                                         onclick="openLightbox('{{ message.attachment.url }}')">
                                {% else %}
                                    <div class="file-attachment">
                                        <div class="file-icon">
                                            {% if message.attachment_type == 'pdf' %}
                                                <i class="fas fa-file-pdf"></i>
                                            {% elif message.attachment_type == 'document' %}
                                                <i class="fas fa-file-word"></i>
                                            {% elif message.attachment_type == 'video' %}
                                                <i class="fas fa-file-video"></i>
                                            {% else %}
                                                <i class="fas fa-file"></i>
                                            {% endif %}
                                        </div>
                                        <div class="file-info">
                                            <div class="file-name">{{ message.attachment.name }}</div>
                                            <div class="file-size">{{ message.attachment.size|filesizeformat }}</div>
                                        </div>
                                        <a href="{{ message.attachment.url }}" 
                                           download 
                                           class="file-download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <div class="message-footer">
                                <span class="message-time">
                                    {{ message.timestamp|date:"g:i A" }}
                                </span>
                                {% if message.sender == request.user %}
                                <span class="read-receipt {% if message.is_read %}read{% endif %}">
                                    {% if message.is_read %}
                                        <i class="fas fa-check-double"></i>
                                    {% else %}
                                        <i class="fas fa-check"></i>
                                    {% endif %}
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        {% if message.sender == request.user %}
                        {% profile_image message.sender size="36" css_class="message-avatar" %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <!-- Input Area -->
            <div class="chat-input-container">
                <!-- Canned Responses -->
                {% if canned_responses %}
                <div class="canned-responses-row">
                    <select class="canned-responses-dropdown" id="canned-responses">
                        <option value="">ðŸ’¬ Quick Responses...</option>
                        {% for response in canned_responses %}
                        <option value="{{ response.message }}">{{ response.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <!-- File Preview Area -->
                <div class="file-preview-area" id="file-preview-area">
                    <div class="file-preview-container">
                        <div class="file-preview-icon" id="file-preview-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="file-preview-info">
                            <div class="file-preview-name" id="file-preview-name">filename.pdf</div>
                            <div class="file-preview-size" id="file-preview-size">0 KB</div>
                        </div>
                        <button type="button" class="file-preview-remove" id="file-preview-remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Input Form -->
                <form id="message-form" class="chat-input-form">
                    {% csrf_token %}
                    <input type="hidden" name="thread_id" value="{{ active_thread.id }}">
                    <input type="file" 
                           id="file-input" 
                           accept="image/*,.pdf,.doc,.docx,.txt" 
                           style="display: none;">

                    <div class="input-actions">
                        <button type="button" class="input-btn" id="attachment-btn" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button type="button" class="input-btn" title="Emoji">
                            <i class="fas fa-smile"></i>
                        </button>
                    </div>

                    <textarea 
                        name="message" 
                        id="message-input"
                        class="message-input" 
                        placeholder="Type a message..."
                        rows="1"></textarea>

                    <button type="submit" class="send-btn" id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="chat-empty-state">
                <i class="fas fa-comments"></i>
                <h3>Select a conversation</h3>
                <p>Choose a conversation from the left to start chatting</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Image Lightbox -->
<div class="image-lightbox" id="image-lightbox" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">
        <i class="fas fa-times"></i>
    </button>
    <img src="" alt="Lightbox" class="lightbox-image" id="lightbox-image">
</div>
{% endblock %}

{% block extra_js %}
{% if active_thread %}
<script>
    // WebSocket connection
    const threadId = Number("{{ active_thread.id }}");
    const currentUserId = Number("{{ request.user.id }}");
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const chatSocket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/chat/' + threadId + '/'
    );

    // DOM elements
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const statusText = document.getElementById('status-text');
    const typingIndicator = document.querySelector('.typing-indicator');
    const cannedResponsesSelect = document.getElementById('canned-responses');
    // Safely read current user's avatar URL from hidden probe element
    const currentUserAvatarEl = document.querySelector('#current-user-avatar-probe img');
    const currentUserAvatarUrl = currentUserAvatarEl ? currentUserAvatarEl.src : '/media/profile_pictures/default.jpeg';
    
    // File attachment elements
    const attachmentBtn = document.getElementById('attachment-btn');
    const fileInput = document.getElementById('file-input');
    const filePreviewArea = document.getElementById('file-preview-area');
    const filePreviewIcon = document.getElementById('file-preview-icon');
    const filePreviewName = document.getElementById('file-preview-name');
    const filePreviewSize = document.getElementById('file-preview-size');
    const filePreviewRemove = document.getElementById('file-preview-remove');
    let selectedFile = null;

    // Scroll to bottom
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Initial scroll
    scrollToBottom();

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Handle Enter key to send message (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevent new line
            messageForm.dispatchEvent(new Event('submit'));
        }
    });

    // Typing indicator
    let typingTimer;
    messageInput.addEventListener('input', function() {
        clearTimeout(typingTimer);
        chatSocket.send(JSON.stringify({
            'type': 'typing',
            'is_typing': true
        }));
        typingTimer = setTimeout(() => {
            chatSocket.send(JSON.stringify({
                'type': 'typing',
                'is_typing': false
            }));
        }, 1000);
    });

    // Canned responses
    if (cannedResponsesSelect) {
        cannedResponsesSelect.addEventListener('change', function() {
            if (this.value) {
                messageInput.value = this.value;
                messageInput.focus();
                this.value = '';
            }
        });
    }

    // File attachment
    attachmentBtn.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            showFilePreview(file);
        }
    });

    function showFilePreview(file) {
        const fileType = getFileType(file.name);
        const iconHtml = {
            'image': '<i class="fas fa-image"></i>',
            'pdf': '<i class="fas fa-file-pdf"></i>',
            'document': '<i class="fas fa-file-word"></i>',
            'video': '<i class="fas fa-file-video"></i>',
            'file': '<i class="fas fa-file"></i>'
        };

        filePreviewIcon.innerHTML = iconHtml[fileType] || iconHtml['file'];
        filePreviewName.textContent = file.name;
        filePreviewSize.textContent = formatFileSize(file.size);
        filePreviewArea.classList.add('show');
    }

    filePreviewRemove.addEventListener('click', () => {
        selectedFile = null;
        fileInput.value = '';
        filePreviewArea.classList.remove('show');
    });

    function getFileType(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'image';
        if (ext === 'pdf') return 'pdf';
        if (['doc', 'docx', 'txt'].includes(ext)) return 'document';
        if (['mp4', 'avi', 'mov', 'webm'].includes(ext)) return 'video';
        return 'file';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // WebSocket handlers
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'message') {
            // Don't append message if it's from current user (already appended on send)
            if (data.sender !== '{{ request.user.username }}') {
                appendMessage(data);
                scrollToBottom();
            }
        } else if (data.type === 'typing') {
            if (data.user !== '{{ request.user.username }}') {
                if (data.is_typing) {
                    if (statusText) statusText.textContent = 'typing';
                    if (typingIndicator) typingIndicator.style.display = 'inline';
                } else {
                    if (statusText) statusText.textContent = 'Online';
                    if (typingIndicator) typingIndicator.style.display = 'none';
                }
            }
        } else if (data.type === 'read_receipt') {
            updateReadReceipts(data.message_id);
        } else if (data.type === 'status') {
            if (data.user !== '{{ request.user.username }}') {
                updateUserStatus(data.status === 'online');
            }
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // Form submission
    messageForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        
        if (!message && !selectedFile) {
            return;
        }

        if (selectedFile) {
            await uploadFileWithMessage(message);
        } else {
            // Immediately append the message to UI for current user
            const currentTime = new Date().toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            const tempMessageData = {
                message_id: 'temp-' + Date.now(),
                message: message,
                sender: '{{ request.user.username }}',
                sender_name: '{{ request.user.get_full_name }}',
                sender_avatar: currentUserAvatarUrl,
                timestamp: currentTime,
                is_read: false
            };
            
            appendMessage(tempMessageData);
            scrollToBottom();
            
            // Send via WebSocket
            chatSocket.send(JSON.stringify({
                'type': 'message',
                'message': message
            }));
            
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }
    });

    async function uploadFileWithMessage(message) {
        const formData = new FormData();
        formData.append('attachment', selectedFile);
        formData.append('message', message || '');
        formData.append('thread_id', threadId);

        try {
            const response = await fetch('/chat/upload/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });

            const data = await response.json();
            if (data.status === 'success') {
                messageInput.value = '';
                messageInput.style.height = 'auto';
                selectedFile = null;
                fileInput.value = '';
                filePreviewArea.classList.remove('show');
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload file. Please try again.');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function appendMessage(data) {
        // Check if message already exists (prevent duplicates)
        if (document.querySelector(`[data-message-id="${data.message_id}"]`)) {
            return;
        }
        
        const isSent = data.sender === '{{ request.user.username }}';
        
        // Parse timestamp if it's ISO format
        let displayTime = data.timestamp;
        if (data.timestamp && data.timestamp.includes('T')) {
            const date = new Date(data.timestamp);
            displayTime = date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }
        // Determine avatar URL, prefer URL string; fallback to current user's avatar for own messages
        let avatarUrl = data.sender_avatar || (isSent ? currentUserAvatarUrl : '/media/profile_pictures/default.jpeg');
        
        const messageHtml = `
            <div class="message-wrapper ${isSent ? 'sent' : 'received'}" data-message-id="${data.message_id}">
                ${!isSent ? `<img src="${avatarUrl}" class="message-avatar" alt="Avatar">` : ''}
                <div class="message-bubble">
                    <div class="message-content">${escapeHtml(data.message)}</div>
                    ${data.attachment_url ? `
                        <div class="message-attachment">
                            ${data.attachment_type === 'image' ? `
                                <img src="${data.attachment_url}" alt="Attachment" onclick="openLightbox('${data.attachment_url}')">
                            ` : `
                                <div class="file-attachment">
                                    <div class="file-icon">
                                        ${data.attachment_type === 'pdf' ? '<i class="fas fa-file-pdf"></i>' :
                                          data.attachment_type === 'document' ? '<i class="fas fa-file-word"></i>' :
                                          data.attachment_type === 'video' ? '<i class="fas fa-file-video"></i>' :
                                          '<i class="fas fa-file"></i>'}
                                    </div>
                                    <div class="file-info">
                                        <div class="file-name">${data.attachment_name}</div>
                                        <div class="file-size">${data.attachment_size}</div>
                                    </div>
                                    <a href="${data.attachment_url}" download class="file-download">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            `}
                        </div>
                    ` : ''}
                    <div class="message-footer">
                        <span class="message-time">${displayTime}</span>
                        ${isSent ? '<span class="read-receipt"><i class="fas fa-check"></i></span>' : ''}
                    </div>
                </div>
                ${isSent ? `<img src="${avatarUrl}" class="message-avatar" alt="Avatar">` : ''}
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function updateReadReceipts(messageId) {
        const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageEl) {
            const receipt = messageEl.querySelector('.read-receipt');
            if (receipt) {
                receipt.classList.add('read');
                receipt.innerHTML = '<i class="fas fa-check-double"></i>';
            }
        }
    }

    function updateUserStatus(isOnline) {
        const statusEl = document.getElementById('user-status');
        if (!statusEl) return;
        if (isOnline) {
            statusEl.classList.remove('offline');
            if (statusText) statusText.textContent = 'Online';
        } else {
            statusEl.classList.add('offline');
            if (statusText) statusText.textContent = 'Offline';
        }
    }

    // Image lightbox
    function openLightbox(imageUrl) {
        const lightbox = document.getElementById('image-lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        lightboxImage.src = imageUrl;
        lightbox.classList.add('show');
    }

    function closeLightbox() {
        const lightbox = document.getElementById('image-lightbox');
        lightbox.classList.remove('show');
    }

    // Close lightbox on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLightbox();
        }
    });

    // Mobile back button functionality
    const mobileBackBtn = document.getElementById('mobile-back-btn');
    if (mobileBackBtn) {
        mobileBackBtn.addEventListener('click', function() {
            // Navigate back to thread list on mobile
            window.location.href = "{% url 'chat:thread_list' %}";
        });
    }
</script>
{% endif %}

<!-- Thread search (works without active thread) -->
<script>
    const searchInput = document.getElementById('search-threads');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const threads = document.querySelectorAll('.thread-item');
            threads.forEach(thread => {
                const name = thread.querySelector('.thread-name').textContent.toLowerCase();
                const preview = thread.querySelector('.thread-preview-text')?.textContent.toLowerCase() || '';
                if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                    thread.style.display = 'flex';
                } else {
                    thread.style.display = 'none';
                }
            });
        });
    }

    // Mobile navigation - Show chat view on mobile based on whether a thread is active
    (function() {
        const isThreadActive = !!document.querySelector('.chat-main-header');
        if (window.innerWidth <= 768) {
            const sidebar = document.querySelector('.chat-sidebar');
            if (sidebar) {
                if (isThreadActive) {
                    // On mobile, hide sidebar when viewing a thread
                    sidebar.classList.remove('show-mobile');
                } else {
                    // On mobile, show sidebar when no thread is selected
                    sidebar.classList.add('show-mobile');
                }
            }
        }
    })();
</script>
{% endblock %}