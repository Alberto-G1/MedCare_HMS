{% extends 'base_shared.html' %}
{% load chat_extras %}
{% load theme_tags %}
{% block title %}Chat{% endblock %}

{% block content %}
<style>
    :root {
        --chat-gradient-1: #0E7490;
        --chat-gradient-2: #0C4A6E;
        --message-sent: linear-gradient(135deg, #0284C7 0%, #0369A1 100%);
        --message-received: #F8FAFC;
        --chat-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
        --message-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
        --hover-shadow: 0 8px 25px rgba(15, 23, 42, 0.12);
        --border-radius: 20px;
        --message-radius: 18px;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 85vh;
        background: linear-gradient(145deg, #FFFFFF 0%, #F8FAFC 100%);
        border-radius: var(--border-radius);
        box-shadow: var(--chat-shadow);
        overflow: hidden;
        position: relative;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .chat-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, 
            var(--accent-green) 0%, 
            var(--sky-blue) 33%, 
            var(--accent-blue) 66%, 
            var(--accent-orange) 100%);
        z-index: 1;
    }

    .chat-header {
        background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-dark-teal) 100%);
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        overflow: hidden;
    }

    .chat-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><pattern id="grain" width="100" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="30" cy="5" r="0.5" fill="rgba(255,255,255,0.02)"/><circle cx="50" cy="15" r="0.8" fill="rgba(255,255,255,0.02)"/><circle cx="70" cy="8" r="0.6" fill="rgba(255,255,255,0.03)"/><circle cx="90" cy="12" r="0.4" fill="rgba(255,255,255,0.02)"/></pattern></defs><rect width="100" height="20" fill="url(%23grain)"/></svg>');
        pointer-events: none;
    }

    .chat-avatar-sm {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent-green) 0%, var(--sky-blue) 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 1rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        border: 3px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }

    .chat-avatar-sm::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
        transform: rotate(45deg);
        transition: transform 0.6s ease;
    }

    .chat-avatar-sm:hover::after {
        transform: rotate(45deg) translateX(100%);
    }

    .chat-avatar-sm img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .chat-header-info h5 { 
        margin-bottom: 0.2rem; 
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .chat-header-info small { 
        color: rgba(255, 255, 255, 0.8); 
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .online-indicator {
        width: 8px;
        height: 8px;
        background-color: var(--accent-green);
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    .chat-header-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chat-header-actions .btn {
        color: white;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
    }

    .chat-header-actions .btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .chat-log {
        flex-grow: 1;
        padding: 2rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: linear-gradient(180deg, #FAFBFC 0%, #F1F5F9 100%);
        position: relative;
    }

    .chat-log::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        width: 2px;
        height: 100%;
        background: linear-gradient(180deg, 
            transparent 0%, 
            rgba(148, 163, 184, 0.1) 20%, 
            rgba(148, 163, 184, 0.1) 80%, 
            transparent 100%);
        transform: translateX(-50%);
        pointer-events: none;
    }

    .message {
        display: flex;
        align-items: flex-end;
        margin-bottom: 0.5rem;
        max-width: 75%;
        opacity: 0;
        transform: translateY(20px);
        animation: messageSlideIn 0.4s ease forwards;
    }

    @keyframes messageSlideIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--sky-blue) 0%, var(--accent-blue) 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
    }

    .message-avatar::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
        transform: rotate(45deg) translateX(-100%);
        transition: transform 0.6s ease;
    }

    .message:hover .message-avatar::before {
        transform: rotate(45deg) translateX(100%);
    }

    .message.sent {
        flex-direction: row-reverse;
        align-self: flex-end;
    }

    .message.sent .message-avatar {
        margin-left: 1rem;
        background: linear-gradient(135deg, var(--accent-green) 0%, #16A34A 100%);
    }

    .message.received .message-avatar {
        margin-right: 1rem;
    }

    .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .message-content {
        padding: 1rem 1.5rem;
        border-radius: var(--message-radius);
        word-wrap: break-word;
        position: relative;
        box-shadow: var(--message-shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        line-height: 1.5;
        font-weight: 400;
    }

    .message-content:hover {
        box-shadow: var(--hover-shadow);
        transform: translateY(-1px);
    }

    .message.sent .message-content {
        background: var(--message-sent);
        color: white;
        border-bottom-right-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message.sent .message-content::before {
        content: '';
        position: absolute;
        bottom: 0;
        right: -8px;
        width: 0;
        height: 0;
        border: 8px solid transparent;
        border-left-color: #0369A1;
        border-bottom: none;
        border-right: none;
    }

    .message.received .message-content {
        background: var(--message-received);
        color: var(--text-dark);
        border-bottom-left-radius: 6px;
        border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .message.received .message-content::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: -8px;
        width: 0;
        height: 0;
        border: 8px solid transparent;
        border-right-color: #F8FAFC;
        border-bottom: none;
        border-left: none;
    }

    .message-time {
        font-size: 0.75rem;
        color: #64748B;
        margin-top: 0.5rem;
        font-weight: 500;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }

    .message:hover .message-time {
        opacity: 1;
    }

    .message.sent .message-time { 
        text-align: right; 
    }

    .chat-input-area {
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
        border-top: 1px solid rgba(148, 163, 184, 0.1);
        position: relative;
    }

    .chat-input-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: 2rem;
        right: 2rem;
        height: 1px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(148, 163, 184, 0.3) 50%, 
            transparent 100%);
    }

    .input-group {
        position: relative;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    #chat-message-input {
        border-radius: 25px;
        border: 2px solid rgba(148, 163, 184, 0.2);
        padding: 1rem 1.5rem;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #chat-message-input:focus {
        border-color: var(--sky-blue);
        box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1);
        background: rgba(255, 255, 255, 0.95);
        outline: none;
    }

    #chat-message-input::placeholder {
        color: #94A3B8;
        font-weight: 400;
    }

    #chat-message-submit {
        border-radius: 50%;
        width: 55px;
        height: 55px;
        background: linear-gradient(135deg, var(--sky-blue) 0%, var(--accent-blue) 100%);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 6px 20px rgba(2, 132, 199, 0.3);
        position: relative;
        overflow: hidden;
    }

    #chat-message-submit::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
        transform: rotate(45deg) translateX(-100%);
        transition: transform 0.6s ease;
    }

    #chat-message-submit:hover::before {
        transform: rotate(45deg) translateX(100%);
    }

    #chat-message-submit:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 10px 30px rgba(2, 132, 199, 0.4);
    }

    #chat-message-submit:active {
        transform: translateY(-1px) scale(0.98);
    }

    #chat-message-submit i {
        font-size: 1.1rem;
        position: relative;
        z-index: 1;
    }

    /* Scrollbar Styling */
    .chat-log::-webkit-scrollbar {
        width: 6px;
    }

    .chat-log::-webkit-scrollbar-track {
        background: rgba(148, 163, 184, 0.1);
        border-radius: 3px;
    }

    .chat-log::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--sky-blue) 0%, var(--accent-blue) 100%);
        border-radius: 3px;
    }

    .chat-log::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, var(--accent-blue) 0%, var(--primary-teal) 100%);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .chat-container {
            height: 90vh;
            margin: 0.5rem;
            border-radius: 16px;
        }

        .chat-header {
            padding: 1rem 1.5rem;
        }

        .chat-avatar-sm {
            width: 45px;
            height: 45px;
        }

        .chat-log {
            padding: 1rem;
        }

        .message {
            max-width: 85%;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
        }

        .message-content {
            padding: 0.875rem 1.25rem;
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
        }

        #chat-message-submit {
            width: 50px;
            height: 50px;
        }

        .chat-header-actions .btn {
            width: 40px;
            height: 40px;
        }
    }

    /* Typing Indicator Animation */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: var(--message-received);
        border-radius: var(--message-radius);
        border-bottom-left-radius: 6px;
        opacity: 0.8;
        animation: fadeIn 0.3s ease;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #94A3B8;
        animation: typingDots 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typingDots {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 0.8; transform: translateY(0); }
    }
</style>

{% with other_user=thread.participants.all|first_if_not:request.user %}
<div class="chat-container">
    <div class="chat-header">
        <div class="d-flex align-items-center">
            <div class="chat-avatar-sm">
                {% if other_user.doctorprofile.profile_picture and other_user.doctorprofile.profile_picture.url != '/media/profile_pictures/default.jpeg' %}
                    <img src="{{ other_user.doctorprofile.profile_picture.url }}" alt="Avatar">
                {% elif other_user.patientprofile.profile_picture and other_user.patientprofile.profile_picture.url != '/media/profile_pictures/default.jpeg' %}
                    <img src="{{ other_user.patientprofile.profile_picture.url }}" alt="Avatar">
                {% else %}
                    {{ other_user.first_name|first|upper }}{{ other_user.last_name|first|upper }}
                {% endif %}
            </div>
            <div class="chat-header-info">
                <h5>{{ other_user.get_full_name|default:other_user.username }}</h5>
                <small>
                    <span class="online-indicator"></span>
                    Online â€¢ Last seen now
                </small>
            </div>
        </div>
        <div class="chat-header-actions">
            <button class="btn" title="Video Call">
                <i class="fas fa-video"></i>
            </button>
            <button class="btn" title="Voice Call">
                <i class="fas fa-phone"></i>
            </button>
            <button class="btn" title="Chat Info">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>
    </div>
    
    <div class="chat-log" id="chat-log">
        {% for message in messages %}
            <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                <div class="message-avatar">
                    {% with sender=message.sender %}
                        {% if sender.doctorprofile.profile_picture and sender.doctorprofile.profile_picture.url != '/media/profile_pictures/default.jpeg' %}
                            <img src="{{ sender.doctorprofile.profile_picture.url }}" alt="Avatar">
                        {% elif sender.patientprofile.profile_picture and sender.patientprofile.profile_picture.url != '/media/profile_pictures/default.jpeg' %}
                            <img src="{{ sender.patientprofile.profile_picture.url }}" alt="Avatar">
                        {% elif sender.receptionistprofile.profile_picture and sender.receptionistprofile.profile_picture.url != '/media/profile_pictures/default.jpeg' %}
                            <img src="{{ sender.receptionistprofile.profile_picture.url }}" alt="Avatar">
                        {% else %}
                            {{ sender.first_name|first|upper }}{{ sender.last_name|first|upper }}
                        {% endif %}
                    {% endwith %}
                </div>
                <div>
                    <div class="message-content">{{ message.message }}</div>
                    <div class="message-time">{{ message.timestamp|date:"g:i A" }}</div>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <div class="chat-input-area">
        <form id="chat-form" class="input-group">
            <input id="chat-message-input" type="text" class="form-control" placeholder="Type your message..." autocomplete="off">
            <button id="chat-message-submit" type="submit" class="btn" title="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>
{% endwith %}

{{ thread.id|json_script:"thread-id" }}
{{ request.user.username|json_script:"request-user-username" }}
{{ request.user.doctorprofile.profile_picture.url|default:''|json_script:"request-user-avatar" }}
{{ other_user.doctorprofile.profile_picture.url|default:''|json_script:"other-user-avatar" }}
{{ request.user.first_name|first|upper|json_script:"request-user-initials-first" }}
{{ request.user.last_name|first|upper|json_script:"request-user-initials-last" }}
{{ other_user.first_name|first|upper|json_script:"other-user-initials-first" }}
{{ other_user.last_name|first|upper|json_script:"other-user-initials-last" }}

<script>
    // --- 1. Get all necessary data from the Django template ---
    const threadId = JSON.parse(document.getElementById('thread-id').textContent);
    const requestUserUsername = JSON.parse(document.getElementById('request-user-username').textContent);
    
    // Get profile picture URLs. Use a fallback for the default image to avoid errors.
    const requestUserAvatarUrl = JSON.parse(document.getElementById('request-user-avatar').textContent) || '/media/profile_pictures/default.jpeg';
    const otherUserAvatarUrl = JSON.parse(document.getElementById('other-user-avatar').textContent) || '/media/profile_pictures/default.jpeg';
    
    // Get user initials for fallback
    const requestUserInitials = (JSON.parse(document.getElementById('request-user-initials-first').textContent) || '') + 
                              (JSON.parse(document.getElementById('request-user-initials-last').textContent) || '');
    const otherUserInitials = (JSON.parse(document.getElementById('other-user-initials-first').textContent) || '') +
                            (JSON.parse(document.getElementById('other-user-initials-last').textContent) || '');
    
    const chatLog = document.querySelector('#chat-log');
    const chatForm = document.querySelector('#chat-form');
    const messageInput = document.querySelector('#chat-message-input');

    // --- 2. Auto-scroll to the latest message on page load ---
    chatLog.scrollTop = chatLog.scrollHeight;

    // --- 3. Establish WebSocket connection ---
    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + 
        window.location.host + 
        '/ws/chat/' + threadId + '/'
    );

    // --- 4. Handle incoming messages from the WebSocket ---
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const isSentByMe = data.sender === requestUserUsername;

        // Determine which avatar URL and initials to use
        const avatarUrl = isSentByMe ? requestUserAvatarUrl : otherUserAvatarUrl;
        const initials = isSentByMe ? requestUserInitials : otherUserInitials;

        // --- Create the message elements dynamically ---
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSentByMe ? 'sent' : 'received'}`;

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        
        // Logic to display image or initials
        if (avatarUrl && avatarUrl !== '/media/profile_pictures/default.jpeg') {
            avatarDiv.innerHTML = `<img src="${avatarUrl}" alt="Avatar">`;
        } else {
            avatarDiv.textContent = initials || '?';
        }

        const contentWrapper = document.createElement('div');

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = data.message;
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        contentWrapper.appendChild(contentDiv);
        contentWrapper.appendChild(timeDiv);
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentWrapper);
        
        chatLog.appendChild(messageDiv);
        
        // Auto-scroll to the new message
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly. Code:', e.code, 'Reason:', e.reason);
    };

    // --- 5. Handle form submission to send messages ---
    messageInput.focus();
    chatForm.onsubmit = function(e) {
        e.preventDefault();
        const message = messageInput.value;
        
        // Prevent sending empty messages
        if (message.trim() === '') {
            return;
        }

        chatSocket.send(JSON.stringify({
            'message': message
        }));
        
        messageInput.value = ''; // Clear the input field
    };

    // Add smooth typing animation for new messages
    document.addEventListener('DOMContentLoaded', function() {
        const messages = document.querySelectorAll('.message');
        messages.forEach((message, index) => {
            message.style.animationDelay = `${index * 0.1}s`;
        });
    });
</script>
{% endblock %}
