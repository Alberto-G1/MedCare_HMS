{% extends 'base.html' %}
{% load billing_extras %}
{% block title %}Bill #{{ bill.pk }} Details{% endblock %}

{% block content %}
<div class="card card-custom">
    <!-- Card Header with Navigation -->
    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0">Bill Details for {{ bill.patient.user.get_full_name }}</h4>
            <div class="d-flex align-items-center mt-2">
                <img src="{{ bill.patient.profile_picture.url }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                <small>Bill ID: #{{ bill.pk }}</small>
            </div>
        </div>
        <a href="{% url 'billing:bill_list' %}" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left me-2"></i>Back to Bill List
        </a>
    </div>
    
    <div class="card-body">
        <!-- Bill Summary Row -->
        <div class="row mb-4 align-items-center">
            <div class="col-md-3"><strong>Total Amount:</strong><h4 class="fw-bold text-primary">{{ bill.total_amount|currency_ugx }}</h4></div>
            <div class="col-md-3"><strong>Amount Paid:</strong><h4 class="fw-bold text-success">{{ bill.amount_paid|currency_ugx }}</h4></div>
            <div class="col-md-3"><strong>Amount Due:</strong><h4 class="fw-bold text-danger">{{ bill.amount_due|currency_ugx }}</h4></div>
            <div class="col-md-3"><strong>Status:</strong><br>
                {% if bill.status == 'Paid' %}<span class="badge bg-success fs-6">{{ bill.status }}</span>
                {% elif bill.status == 'Unpaid' %}<span class="badge bg-danger fs-6">{{ bill.status }}</span>
                {% else %}<span class="badge bg-warning fs-6">{{ bill.status }}</span>
                {% endif %}
            </div>
        </div>
        <hr>
        
        <!-- Bill Items Section Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Bill Items</h5>
            <div>
                <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#updateStatusModal" {% if bill.status == 'Paid' %}disabled{% endif %}>
                    <i class="fas fa-edit"></i> Update Payment
                </button>
                <button type="button" class="btn btn-sm btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addItemModal" {% if bill.status == 'Paid' %}disabled{% endif %}>
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        </div>

        <!-- Bill Items Table -->
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-light">
                    <tr><th>Description</th><th class="text-center">Qty</th><th class="text-end">Unit Price</th><th class="text-end">Amount</th><th class="text-center">Actions</th></tr>
                </thead>
                <tbody>
                    {% for item in bill.items.all %}
                    <tr>
                        <td>{{ item.description }}</td>
                        <td class="text-center">{{ item.quantity }}</td>
                        <td class="text-end">{{ item.unit_price|currency_ugx }}</td>
                        <td class="text-end">{{ item.amount|currency_ugx }}</td>
                        <td class="text-center">
                            {% if "Consultation with" not in item.description and bill.status != 'Paid' %}
                                <a href="{% url 'billing:edit_bill_item' item.pk %}" class="btn btn-sm btn-outline-info" title="Edit Item"><i class="fas fa-pen"></i></a>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteItemModal-{{ item.pk }}" title="Delete Item"><i class="fas fa-trash"></i></button>
                            {% else %}
                                <span class="text-muted small">--</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <hr>
        <div class="d-flex justify-content-end gap-2">
            {% if bill.status != 'Unpaid' %}
                <a href="{% url 'billing:bill_receipt' bill.pk %}" target="_blank" class="btn btn-sky"><i class="fas fa-print me-2"></i>Print Receipt</a>
            {% endif %}
        </div>
    </div>
</div>


<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addItemModalLabel">Add New Item to Bill #{{ bill.pk }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'billing:add_bill_item' bill.pk %}" method="post">
          {% csrf_token %}
          <div class="modal-body">
              {{ item_form.as_p }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary-custom">Add Item</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Update Payment Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Update Payment</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <form action="{% url 'billing:update_bill_status' bill.pk %}" method="post">
          {% csrf_token %}
          <div class="modal-body">
                <div class="mb-3">
                    <label for="id_status" class="form-label">Payment Status</label>
                    {{ payment_form.status }}
                </div>
                <div id="partial-payment-field" class="mb-3" style="display: none;">
                    <label for="id_new_payment_amount" class="form-label">Amount Being Paid Now</label>
                    {{ payment_form.new_payment_amount }}
                    <small class="text-muted">Enter the amount the patient is paying right now.</small>
                </div>
                <div class="mb-3">
                    <label for="id_payment_method" class="form-label">Payment Method</label>
                    {{ payment_form.payment_method }}
                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary-custom">Update Payment</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateStatusModalLabel">Update Payment Status for Bill #{{ bill.pk }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'billing:update_bill_status' bill.pk %}" method="post">
          {% csrf_token %}
          <div class="modal-body">
                <p>Current Status: <strong>{{ bill.get_status_display }}</strong></p>
                <div class="mb-3">
                    <label for="status-select" class="form-label">New Status</label>
                    <select name="status" id="status-select" class="form-select">
                        <option value="Unpaid" {% if bill.status == 'Unpaid' %}selected{% endif %}>Unpaid</option>
                        <option value="Paid" {% if bill.status == 'Paid' %}selected{% endif %}>Paid</option>
                        <option value="Partially Paid" {% if bill.status == 'Partially Paid' %}selected{% endif %}>Partially Paid</option>
                    </select>
                </div>
                <!-- Future enhancement: Add payment method selection here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary-custom">Update Status</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Item Confirmation Modals (one for each item) -->
{% for item in bill.items.all %}
    {% if "Consultation with" not in item.description %}
    <div class="modal fade" id="deleteItemModal-{{ item.pk }}" tabindex="-1" aria-labelledby="deleteItemModalLabel-{{ item.pk }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteItemModalLabel-{{ item.pk }}">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete the item: <strong>"{{ item.description }}"</strong>? This action cannot be undone.
          </div>
          <div class="modal-footer">
            <form action="{% url 'billing:delete_bill_item' item.pk %}" method="post">
                {% csrf_token %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Yes, Delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
{% endfor %}

<!-- ADD THIS SCRIPT BLOCK FOR DYNAMIC BEHAVIOR -->

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('id_status');
    if (statusSelect) {
        const partialPaymentField = document.getElementById('partial-payment-field');

        function togglePartialPaymentField() {
            if (statusSelect.value === 'Partially Paid') {
                partialPaymentField.style.display = 'block';
            } else {
                partialPaymentField.style.display = 'none';
            }
        }
        togglePartialPaymentField();
        statusSelect.addEventListener('change', togglePartialPaymentField);
    }
});
</script>
{% endblock %}

{% endblock %}
