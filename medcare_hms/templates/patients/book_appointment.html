{% extends 'base.html' %}
{% block title %}Book a New Appointment{% endblock %}

{% block content %}
<style>
    .doctor-card {
        border: 2px solid transparent;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .doctor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px var(--shadow-light);
    }
    .doctor-card.selected {
        border-color: var(--primary-dark-teal);
        box-shadow: 0 8px 20px var(--shadow-light);
        background-color: #f0f8ff; /* A light blue to indicate selection */
    }
    .doctor-card-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
    }
</style>

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card card-custom">
            <div class="card-header card-header-custom">
                <h4 class="mb-0"><i class="fas fa-calendar-plus me-2"></i>Schedule a New Appointment</h4>
            </div>
            <div class="card-body p-4">
                <p class="text-muted">Please select a doctor and fill out the details below to request an appointment.</p>
                <hr>
                
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <!-- This hidden input will store the ID of the selected doctor -->
                    {{ form.doctor }}

                    <!-- Display any form-wide errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <!-- Step 1: Doctor Selection Cards -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Step 1: Choose a Doctor</label>
                        <div id="doctor-selection-container" class="row">
                            {% for doctor in doctors %}
                            <div class="col-md-4 mb-3">
                                <div class="card doctor-card h-100" data-doctor-id="{{ doctor.id }}">
                                    <div class="card-body text-center">
                                        <img src="{{ doctor.profile_picture.url }}" class="rounded-circle doctor-card-img mb-2" alt="Dr. {{ doctor.user.get_full_name }}">
                                        <h6 class="card-title mb-1">{{ doctor }}</h6>
                                        <p class="card-text text-muted small">{{ doctor.specialization }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.doctor.errors %}<div id="doctor-error" class="text-danger small mt-1">{{ form.doctor.errors.as_text }}</div>{% endif %}
                    </div>
                    
                    <!-- Step 2: Appointment Details -->
                    <div id="appointment-details-section" style="display: none;">
                        <hr class="my-4">
                        <label class="form-label fw-bold">Step 2: Provide Appointment Details</label>
                        
                        <!-- Date and Time -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.appointment_date.id_for_label }}" class="form-label">{{ form.appointment_date.label }}</label>
                                {{ form.appointment_date }}
                                {% if form.appointment_date.errors %}<div class="text-danger small mt-1">{{ form.appointment_date.errors.as_text }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.appointment_time.id_for_label }}" class="form-label">{{ form.appointment_time.label }}</label>
                                {{ form.appointment_time }}
                                {% if form.appointment_time.errors %}<div class="text-danger small mt-1">{{ form.appointment_time.errors.as_text }}</div>{% endif %}
                            </div>
                        </div>

                        <!-- Reason for Visit -->
                        <div class="mb-3">
                            <label for="{{ form.reason.id_for_label }}" class="form-label">{{ form.reason.label }}</label>
                            {{ form.reason }}
                            {% if form.reason.errors %}<div class="text-danger small mt-1">{{ form.reason.errors.as_text }}</div>{% endif %}
                        </div>
                        
                        <!-- Optional Attachment -->
                        <div class="mb-4">
                            <label for="{{ form.attachment.id_for_label }}" class="form-label">{{ form.attachment.label }}</gabel>
                            {{ form.attachment }}
                            {% if form.attachment.errors %}<div class="text-danger small mt-1">{{ form.attachment.errors.as_text }}</div>{% endif %}
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                            <a href="{% url 'patients:my_appointments' %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary-custom"><i class="fas fa-paper-plane me-2"></i>Submit Request</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const doctorCards = document.querySelectorAll('.doctor-card');
    const hiddenDoctorInput = document.getElementById('{{ form.doctor.id_for_label }}');
    const detailsSection = document.getElementById('appointment-details-section');
    const doctorError = document.getElementById('doctor-error');

    doctorCards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove 'selected' class from all other cards
            doctorCards.forEach(c => c.classList.remove('selected'));
            
            // Add 'selected' class to the clicked card
            this.classList.add('selected');
            
            // Set the value of the hidden input field to the doctor's ID
            hiddenDoctorInput.value = this.dataset.doctorId;
            
            // Show the rest of the form
            detailsSection.style.display = 'block';

            // Hide the doctor error message if it was visible
            if (doctorError) {
                doctorError.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}