{% extends 'base_doctor.html' %}

{% block title %}Manage My Availability{% endblock %}

{% block content %}
<div class="card card-custom">
    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="fas fa-user-clock me-2"></i>My Weekly Schedule</h4>
        <button type="button" class="btn btn-sky btn-sm" data-bs-toggle="modal" data-bs-target="#addSlotModal">
            <i class="fas fa-plus me-2"></i>Add New Time Slot
        </button>
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            {% for slot in slots %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong class="d-block">{{ slot.get_day_of_week_display }}</strong>
                    <span class="text-muted">{{ slot.start_time|time:"g:i A" }} - {{ slot.end_time|time:"g:i A" }}</span>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-info edit-slot-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#editSlotModal"
                            data-slot-id="{{ slot.id }}"
                            data-day="{{ slot.day_of_week }}"
                            data-start="{{ slot.start_time|time:'H:i' }}"
                            data-end="{{ slot.end_time|time:'H:i' }}">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteSlotModal-{{ slot.id }}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </li>
            {% empty %}
            <li class="list-group-item text-center text-muted py-4">You have not set any available time slots.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- ======================= MODALS ======================= -->

<!-- Add New Slot Modal -->
<div class="modal fade" id="addSlotModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Time Slot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{% url 'doctors:manage_availability' %}" method="post">
          {% csrf_token %}
          <div class="modal-body">
              <div class="mb-3"><label for="id_day_of_week_add" class="form-label">Day of week:</label>{{ form.day_of_week }}</div>
              <div class="mb-3"><label for="id_start_time_add" class="form-label">Start time:</label>{{ form.start_time }}</div>
              <div class="mb-3"><label for="id_end_time_add" class="form-label">End time:</label>{{ form.end_time }}</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary-custom">Add Slot</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Slot Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Time Slot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editSlotForm" method="post"> {# Action will be set by JS #}
          {% csrf_token %}
          <div class="modal-body">
              <div class="mb-3"><label for="id_day_of_week_edit" class="form-label">Day of week:</label>{{ form.day_of_week }}</div>
              <div class="mb-3"><label for="id_start_time_edit" class="form-label">Start time:</label>{{ form.start_time }}</div>
              <div class="mb-3"><label for="id_end_time_edit" class="form-label">End time:</label>{{ form.end_time }}</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary-custom">Save Changes</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modals -->
{% for slot in slots %}
<div class="modal fade" id="deleteSlotModal-{{ slot.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Confirm Deletion</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">Are you sure you want to delete this time slot?</div>
      <div class="modal-footer">
        <form action="{% url 'doctors:delete_availability' slot.pk %}" method="post">
            {% csrf_token %}
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Yes, Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editSlotModal = document.getElementById('editSlotModal');
    
    editSlotModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; 
        
        const slotId = button.dataset.slotId;
        const day = button.dataset.day;
        const startTime = button.dataset.start;
        const endTime = button.dataset.end;

        const form = editSlotModal.querySelector('#editSlotForm');
        
        // --- THIS IS THE ROBUST FIX ---
        // We select the inputs within the specific edit form by their 'name' attribute,
        // which is guaranteed to be unique within that form.
        const daySelect = form.querySelector('select[name="day_of_week"]');
        const startInput = form.querySelector('input[name="start_time"]');
        const endInput = form.querySelector('input[name="end_time"]');
        // --- END OF FIX ---

        // Construct the URL for the form's action attribute
        const url = `/doctor/availability/${slotId}/edit/`;
        form.action = url;
        
        // Update the modal's form fields with the data from the clicked button
        if(daySelect) daySelect.value = day;
        if(startInput) startInput.value = startTime;
        if(endInput) endInput.value = endTime;
    });
});
</script>
{% endblock %}